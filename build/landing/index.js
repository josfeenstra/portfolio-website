(()=>{"use strict";class t{constructor(t,e,s=[]){this._height=t,this._width=e,this.data=new Uint16Array(this._width*this._height),s==[]||0==s.length?this.fill(0):this.setData(s)}static fromList(e,s){let r=e.length/s,i=new t(r,s);for(let t=0;t<e.length;t++)i.data[t]=e[t];return i}print(){let t=[];for(var e=0;e<this._height;e++){t.push("|");for(var s=0;s<this._width;s++){let r=this.get(e,s).toFixed(2);r=r.padStart(8," "),t.push(r),s<this._width-2&&t.push("  ")}t.push("  |\n")}console.log(t.join(""))}clone(){let e=new t(this._height,this._width);return e.data=this.data,e}setData(t){if(t.length!=this._height*this._width)throw"data.length does not match width * height "+t.length.toString();this.data.set(t)}count(){return this._height}getDimensions(){return[this._height,this._width]}inRange(t,e){return!(t<0||t>this._height-1||e<0||e>this._width-1)}fill(t){let e=this._height*this._width;for(let s=0;s<e;s++)this.data[s]=t}fillWith(t,e=this._width){let s=e;if(s>this._width)throw"values per entry is larger than this._width. This will spill over.";for(let e=0;e<this._height;e++)for(let r=0;r<s;r++)this.set(e,r,t[e*s+r])}get(t,e){return this.inRange(t,e)?this.data[t*this._width+e]:(console.warn("out of range!"),0)}getRow(t){let e=new Uint16Array(this._width);for(let s=0;s<this._width;s++)e[s]=this.get(t,s);return e}getColumn(t){let e=new Uint16Array(this._height);for(let s=0;s<this._height;s++){let r=s*this._width+t;e[s]=this.data[r]}return e}set(t,e,s){this.inRange(t,e)?this.data[t*this._width+e]=s:console.warn("out of range!")}setRow(t,e){for(let s=0;s<this._width;s++)this.set(t,s,e[s])}takeRows(e){console.log(this._height,this._width);const s=e.length;let r=new t(s,this._width);for(let t=0;t<s;t++){let s=e[t];r.setRow(t,this.getRow(s))}return r}getData(){return this.data}forEachValue(t){for(let e=0;e<this.data.length;e++)this.data[e]=t(this.data[e],e);return this}forEachRow(t){for(let e=0;e<this._height;e++){let s=this.getRow(e);t(s,e),this.setRow(e,s)}return this}trueForAll(t){for(let e=0;e<this.data.length;e++)if(!t(this.data[e],e))return!1;return!0}}class e{static IsRouglyZero(t){return Math.abs(t)<this.TOLERANCE}}e.TOLERANCE=1e-4,e.TOL_SQUARED=Math.pow(e.TOLERANCE,2),e.MAX_U16=65536,e.PLANE_RENDER_LINECOUNT=9,e.PLANE_RENDER_LINEDISTANCE=.3,e.CIRCLE_SEGMENTS=100;class s{static clamp(t,e,s){return Math.min(Math.max(t,e),s)}static fade(t){return t*t*t*(t*(6*t-15)+10)}static lerp(t,e,s){return t+s*(e-t)}static radToDeg(t){return 180*t/Math.PI}static degToRad(t){return t*Math.PI/180}}class r{constructor(t,e,s=[]){this._height=t,this._width=e,this.data=new Float32Array(this._width*this._height),s==[]||0==s.length?this.fill(0):this.setData(s)}print(){let t=[];for(var e=0;e<this._height;e++){t.push("|");for(var s=0;s<this._width;s++){let r=this.get(e,s).toFixed(2);r=r.padStart(8," "),t.push(r),s<this._width-2&&t.push("  ")}t.push("  |\n")}console.log(t.join(""))}clone(){let t=new r(this._height,this._width);for(let e=0;e<this.data.length;e++)t.data[e]=this.data[e];return t}setData(t){if(t.length!=this._height*this._width)throw"data.length does not match width * height "+t.length.toString();this.data.set(t)}count(){return this._height}getDimensions(){return[this._height,this._width]}fill(t){let e=this._height*this._width;for(let s=0;s<e;s++)this.data[s]=t}fillWith(t,e=this._width){let s=e;if(s>this._width)throw"values per entry is larger than this._width. This will spill over.";for(let e=0;e<this._height;e++)for(let r=0;r<s;r++)this.set(e,r,t[e*s+r])}get(t,e){return this.data[t*this._width+e]}getRow(t){let e=new Float32Array(this._width);for(let s=0;s<this._width;s++)e[s]=this.get(t,s);return e}getColumn(t){let e=new Float32Array(this._height);for(let s=0;s<this._height;s++){let r=s*this._width+t;e[s]=this.data[r]}return e}set(t,e,s){this.data[t*this._width+e]=s}setRow(t,e){for(let s=0;s<this._width;s++)this.set(t,s,e[s])}forEachValue(t){for(let e=0;e<this.data.length;e++)this.data[e]=t(this.data[e],e);return this}takeRows(t){const e=t.length;let s=new r(e,this._width);for(let r=0;r<e;r++){let e=t[r];s.setRow(r,this.getRow(e))}return s}mapWith(t,e){let s=this.clone(),r=Math.min(this._width,t._height),i=Math.min(this._height,t._height);for(var n=0;n<i;n++)for(var o=0;o<r;o++)s.set(n,o,e(this.get(n,o),t.get(n,o)));return s}multiply(t){let e=this;if(t._width!==e._height)throw new Error("Columns in A should be the same as the number of rows in B");for(var s=new r(e._height,t._width),i=0;i<s._height;i++)for(var n=0;n<t._width;n++)for(var o=0;o<e._width;o++)s.set(i,n,s.get(i,n)+e.get(i,o)*t.get(o,n));return s}static fromNative(t){let e=t.length,s=t[0].length,i=new r(e,s);for(var n=0;n<t.length;n++)for(var o=0;o<t[0].length;o++)i.set(n,o,t[n][o]);return i}toNative(){let t=[];for(var e=0;e<this._height;e++){t[e]=[];for(var s=0;s<this._width;s++)t[e][s]=this.get(e,s)}return t}}class i extends r{constructor(t=[]){super(4,4,t)}static new(t){return new i(t)}static newIdentity(){return new i([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}static newCopy(t){let e=new i;for(let s=0;s<16;s++)e.data[s]=t.data[s];return e}clone(){return i.newCopy(this)}multiplied(t){const e=t.data,s=this.data;var r=s[0],n=s[1],o=s[2],h=s[3],a=s[4],l=s[5],u=s[6],d=s[7],c=s[8],g=s[9],m=s[10],f=s[11],w=s[12],p=s[13],x=s[14],y=s[15],v=e[0],E=e[1],M=e[2],_=e[3],b=e[4],V=e[5],A=e[6],R=e[7],L=e[8],P=e[9],z=e[10],T=e[11],S=e[12],N=e[13],C=e[14],D=e[15];return new i([r*v+n*b+o*L+h*S,r*E+n*V+o*P+h*N,r*M+n*A+o*z+h*C,r*_+n*R+o*T+h*D,a*v+l*b+u*L+d*S,a*E+l*V+u*P+d*N,a*M+l*A+u*z+d*C,a*_+l*R+u*T+d*D,c*v+g*b+m*L+f*S,c*E+g*V+m*P+f*N,c*M+g*A+m*z+f*C,c*_+g*R+m*T+f*D,w*v+p*b+x*L+y*S,w*E+p*V+x*P+y*N,w*M+p*A+x*z+y*C,w*_+p*R+x*T+y*D])}multiply(t){return this.data=this.multiplied(t).data,this}transpose(){let t=new i,e=t.data,s=this.data;return e[0]=s[0],e[1]=s[4],e[2]=s[8],e[3]=s[12],e[4]=s[1],e[5]=s[5],e[6]=s[9],e[7]=s[13],e[8]=s[2],e[9]=s[6],e[10]=s[10],e[11]=s[14],e[12]=s[3],e[13]=s[7],e[14]=s[11],e[15]=s[15],t}static newLookAt(t,e,s){let r=new i,n=r.data,o=t.clone().sub(e).normalize(),h=s.clone().cross(s).normalize(),a=o.clone().cross(h).normalize();return n[0]=h.x,n[1]=h.y,n[2]=h.z,n[3]=0,n[4]=a.x,n[5]=a.y,n[6]=a.z,n[7]=0,n[8]=o.x,n[9]=o.y,n[10]=o.z,n[11]=0,n[12]=t.x,n[13]=t.y,n[14]=t.z,n[15]=1,r}static newPerspective(t,e,s,r){let n=new i,o=n.data;var h=Math.tan(.5*Math.PI-.5*t),a=1/(s-r);return o[0]=h/e,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=h,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=(s+r)*a,o[11]=-1,o[12]=0,o[13]=0,o[14]=s*r*a*2,o[15]=0,n}static newOrthographic(t,e,s,r,n,o){let h=new i,a=h.data;return a[0]=2/(e-t),a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2/(r-s),a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=2/(n-o),a[11]=0,a[12]=(t+e)/(t-e),a[13]=(s+r)/(s-r),a[14]=(n+o)/(n-o),a[15]=1,h}static newFrustum(t,e,s,r,n,o){let h=new i,a=h.data;var l=e-t,u=r-s,d=o-n;return a[0]=2*n/l,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2*n/u,a[6]=0,a[7]=0,a[8]=(t+e)/l,a[9]=(r+s)/u,a[10]=-(o+n)/d,a[11]=-1,a[12]=0,a[13]=0,a[14]=-2*n*o/d,a[15]=0,h}static newTranslation(t,e,s){return new i([1,0,0,0,0,1,0,0,0,0,1,0,t,e,s,1])}static newXRotation(t){var e=Math.cos(t),s=Math.sin(t);return new i([1,0,0,0,0,e,-s,0,0,s,e,0,0,0,0,1])}static newYRotation(t){var e=Math.cos(t),s=Math.sin(t);return new i([e,0,s,0,0,1,0,0,-s,0,e,0,0,0,0,1])}static newZRotation(t){let e=new i,s=e.data;var r=Math.cos(t),n=Math.sin(t);return s[0]=r,s[1]=n,s[2]=0,s[3]=0,s[4]=-n,s[5]=r,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,e}static newAxisRotation(t,e){let s=new i,r=s.data,n=t.x,o=t.y,h=t.z,a=Math.sqrt(n*n+o*o+h*h);n/=a,o/=a,h/=a;let l=n*n,u=o*o,d=h*h,c=Math.cos(e),g=Math.sin(e),m=1-c;return r[0]=l+(1-l)*c,r[1]=n*o*m+h*g,r[2]=n*h*m-o*g,r[3]=0,r[4]=n*o*m-h*g,r[5]=u+(1-u)*c,r[6]=o*h*m+n*g,r[7]=0,r[8]=n*h*m+o*g,r[9]=o*h*m-n*g,r[10]=d+(1-d)*c,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,s}axisRotate(t,e){let s=new i,r=s.data,n=this.data;var o=t.x,h=t.y,a=t.z,l=Math.sqrt(o*o+h*h+a*a),u=(o/=l)*o,d=(h/=l)*h,c=(a/=l)*a,g=Math.cos(e),m=Math.sin(e),f=1-g,w=u+(1-u)*g,p=o*h*f+a*m,x=o*a*f-h*m,y=o*h*f-a*m,v=d+(1-d)*g,E=h*a*f+o*m,M=o*a*f+h*m,_=h*a*f-o*m,b=c+(1-c)*g,V=n[0],A=n[1],R=n[2],L=n[3],P=n[4],z=n[5],T=n[6],S=n[7],N=n[8],C=n[9],D=n[10],k=n[11];return r[0]=w*V+p*P+x*N,r[1]=w*A+p*z+x*C,r[2]=w*R+p*T+x*D,r[3]=w*L+p*S+x*k,r[4]=y*V+v*P+E*N,r[5]=y*A+v*z+E*C,r[6]=y*R+v*T+E*D,r[7]=y*L+v*S+E*k,r[8]=M*V+_*P+b*N,r[9]=M*A+_*z+b*C,r[10]=M*R+_*T+b*D,r[11]=M*L+_*S+b*k,n!==r&&(r[12]=n[12],r[13]=n[13],r[14]=n[14],r[15]=n[15]),s}static newScaler(t,e,s){return new i([t,0,0,0,0,e,0,0,0,0,s,0,0,0,0,1])}scale(t,e,s){let r=new i,n=r.data,o=this.data;return n[0]=t*o[0],n[1]=t*o[1],n[2]=t*o[2],n[3]=t*o[3],n[4]=e*o[4],n[5]=e*o[5],n[6]=e*o[6],n[7]=e*o[7],n[8]=s*o[8],n[9]=s*o[9],n[10]=s*o[10],n[11]=s*o[11],o!==n&&(n[12]=o[12],n[13]=o[13],n[14]=o[14],n[15]=o[15]),r}newCompose(t,e,s){let r=new i,n=r.data;const o=e.x,h=e.y,a=e.z,l=e.w,u=o+o,d=h+h,c=a+a,g=o*u,m=o*d,f=o*c,w=h*d,p=h*c,x=a*c,y=l*u,v=l*d,E=l*c,M=s.x,_=s.y,b=s.z;return n[0]=(1-(w+x))*M,n[1]=(m+E)*M,n[2]=(f-v)*M,n[3]=0,n[4]=(m-E)*_,n[5]=(1-(g+x))*_,n[6]=(p+y)*_,n[7]=0,n[8]=(f+v)*b,n[9]=(p-y)*b,n[10]=(1-(g+w))*b,n[11]=0,n[12]=t.x,n[13]=t.y,n[14]=t.z,n[15]=1,r}determinate(){let t=this.data;var e=t[0],s=t[1],r=t[2],i=t[3],n=t[4],o=t[5],h=t[6],a=t[7],l=t[8],u=t[9],d=t[10],c=t[11],g=t[12],m=t[13],f=t[14],w=t[15],p=d*w,x=f*c,y=h*w,v=f*a,E=h*c,M=d*a,_=r*w,b=f*i,V=r*c,A=d*i,R=r*a,L=h*i;return 1/(e*(p*o+v*u+E*m-(x*o+y*u+M*m))+n*(x*s+_*u+A*m-(p*s+b*u+V*m))+l*(y*s+b*o+R*m-(v*s+_*o+L*m))+g*(M*s+V*o+L*u-(E*s+A*o+R*u)))}inverse(){let t=new i,e=t.data,s=this.data;var r=s[0],n=s[1],o=s[2],h=s[3],a=s[4],l=s[5],u=s[6],d=s[7],c=s[8],g=s[9],m=s[10],f=s[11],w=s[12],p=s[13],x=s[14],y=s[15],v=m*y,E=x*f,M=u*y,_=x*d,b=u*f,V=m*d,A=o*y,R=x*h,L=o*f,P=m*h,z=o*d,T=u*h,S=c*p,N=w*g,C=a*p,D=w*l,k=a*g,I=c*l,F=r*p,B=w*n,U=r*g,O=c*n,q=r*l,W=a*n,K=v*l+_*g+b*p-(E*l+M*g+V*p),Y=E*n+A*g+P*p-(v*n+R*g+L*p),X=M*n+R*l+z*p-(_*n+A*l+T*p),G=V*n+L*l+T*g-(b*n+P*l+z*g),j=1/(r*K+a*Y+c*X+w*G);return e[0]=j*K,e[1]=j*Y,e[2]=j*X,e[3]=j*G,e[4]=j*(E*a+M*c+V*w-(v*a+_*c+b*w)),e[5]=j*(v*r+R*c+L*w-(E*r+A*c+P*w)),e[6]=j*(_*r+A*a+T*w-(M*r+R*a+z*w)),e[7]=j*(b*r+P*a+z*c-(V*r+L*a+T*c)),e[8]=j*(S*d+D*f+k*y-(N*d+C*f+I*y)),e[9]=j*(N*h+F*f+O*y-(S*h+B*f+U*y)),e[10]=j*(C*h+B*d+q*y-(D*h+F*d+W*y)),e[11]=j*(I*h+U*d+W*f-(k*h+O*d+q*f)),e[12]=j*(C*m+I*x+N*u-(k*x+S*u+D*m)),e[13]=j*(U*x+S*o+B*m-(F*m+O*x+N*o)),e[14]=j*(F*u+W*x+D*o-(q*x+C*o+B*u)),e[15]=j*(q*m+k*o+O*u-(U*u+W*m+I*o)),t}multiplyVector(t){let e=new Array(3);for(var s=0;s<3;++s){e[s]=0;for(var r=0;r<4;++r)e[s]+=t.item(r)*this.get(r,s)}return new n(e[0],e[1],e[2])}multiplyVectors(t){for(let e=0;e<this.count();e++){let s=t.getVector(e);s=this.multiplyVector(s),t.setVector(e,s)}return t}}class n{constructor(t,e,s){this.x=t,this.y=e,this.z=s}static new(t,e,s){return new n(t,e,s)}static calculateWheelOrder(t,e,s){let r=[];t.forEach((t=>{r.push(new h(t.dot(e),t.dot(s)).angle())}));let i=class{static range(t){let e=[];for(let s=0;s<t;s++)e.push(s);return e}}.range(t.length);return i.sort(((t,e)=>r[t]-r[e])),i}static fromLerp(t,e,s){return new n(t.x+(e.x-t.x)*s,t.y+(e.y-t.y)*s,t.z+(e.z-t.z)*s)}static fromArray(t){return new n(t[0],t[1],t[2])}static fromRandom(){return new n(Math.random(),Math.random(),Math.random())}static fromSphere(t,e,s){const r=Math.sin(s)*t;return this.constructor(r*Math.sin(e),Math.cos(s)*t,r*Math.cos(e))}static fromCylinder(t,e,s){return this.constructor(t*Math.sin(e),s,t*Math.cos(e))}static fromLerpWeights(t,e,s,r,i){if(Math.abs(i-s)<1e-5)return t;if(Math.abs(i-r)<1e-5)return e;if(Math.abs(s-r)<1e-5)return t;let o=(i-s)/(r-s);return new n(t.x+o*(e.x-t.x),t.y+o*(e.y-t.y),t.z+o*(e.z-t.z))}static zero(){return new n(0,0,0)}static unitX(){return new n(1,0,0)}static unitY(){return new n(0,1,0)}static unitZ(){return new n(0,0,1)}toArray(){return new Float32Array([this.x,this.y,this.z])}set(t,e,s){return this.x=t,this.y=e,this.z=s,this}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z}toString(){return`Vector3(${this.x}, ${this.y}, ${this.z})`}toVector2(){return new h(this.x,this.y)}clone(){return new n(this.x,this.y,this.z)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}to2D(){return new h(this.x,this.y)}largestValue(){return Math.max(this.x,this.y,this.z)}added(t){return new n(this.x+t.x,this.y+t.y,this.z+t.z)}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}subbed(t){return new n(this.x-t.x,this.y-t.y,this.z-t.z)}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}item(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return 1;default:throw"nope"}}scaled(t){return new n(this.x*t,this.y*t,this.z*t)}scale(t){return this.x*=t,this.y*=t,this.z*=t,this}mul(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}multiplied(t){return new n(this.x*t.x,this.y*t.y,this.z*t.z)}divVector(t){return new n(this.x/t.x,this.y/t.y,this.z/t.z)}divided(t){return new n(this.x/t,this.y/t,this.z/t)}div(t){return this.x/=t,this.y/=t,this.z/=t,this}minimumed(t){return new n(Math.min(this.x,t.x),Math.min(this.y,t.y),Math.min(this.z,t.z))}maximumed(t){return new n(Math.max(this.x,t.x),Math.max(this.y,t.y),Math.max(this.z,t.z))}clamped(t,e){return new n(Math.max(t.x,Math.min(e.x,this.x)),Math.max(t.y,Math.min(e.y,this.y)),Math.max(t.z,Math.min(e.z,this.z)))}clampScalared(t,e){return new n(s.clamp(this.x,t,e),s.clamp(this.y,t,e),s.clamp(this.z,t,e))}clampLengthed(t,e){const s=this.length();return this.div(s||1).scale(Math.max(t,Math.min(e,s)))}floored(){return new n(Math.floor(this.x),Math.floor(this.y),Math.floor(this.z))}ceiled(){return new n(Math.ceil(this.x),Math.ceil(this.y),Math.ceil(this.z))}rounded(){return new n(Math.round(this.x),Math.round(this.y),Math.round(this.z))}roundedToZero(){return new n(this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z<0?Math.ceil(this.z):Math.floor(this.z))}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}negated(){return new n(-this.x,-this.y,-this.z)}angle(t,e){let s=this.subbed(e.scaled(this.dot(e))),r=t.subbed(e.scaled(t.dot(e)));return console.log(s),console.log(r),0}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}cross(t){const e=this.x,s=this.y,r=this.z,i=t.x,o=t.y,h=t.z;return new n(s*h-r*o,r*i-e*h,e*o-s*i)}getLengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.getLengthSquared())}manhat(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.div(this.length()||1)}normalized(){return this.divided(this.length()||1)}isNormal(){return Math.abs(this.length()-1)<e.TOLERANCE}disTo(t){return Math.sqrt(this.disToSquared(t))}disToSquared(t){const e=this.x-t.x,s=this.y-t.y,r=this.z-t.z;return e*e+s*s+r*r}disToManhat(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)+Math.abs(this.z-t.z)}setLength(t){return this.normalize().scale(t)}lerp(t,e){return new n((t.x-this.x)*e,(t.y-this.y)*e,(t.z-this.z)*e)}projectOnVector(t){const e=t.getLengthSquared();if(0===e)return this.set(0,0,0);const s=t.dot(this)/e;return this.copy(t).scale(s)}projectedOnPlane(t){return o.copy(this).projectOnVector(t),this.minimumed(o)}mirrored(t){return this.minimumed(o.copy(t).scale(2*this.dot(t)))}rotated(t,e){return i.newAxisRotation(t,e).multiplyVector(this)}}const o=new n(0,0,0);class h{constructor(t,e){this.x=t,this.y=e}static fromArray(t){return new h(t[0],t[1])}static fromLerp(t,e,s){return new h(t.x+(e.x-t.x)*s,t.y+(e.y-t.y)*s)}static fromRandom(){return new h(Math.random(),Math.random())}static fromRandomAngle(){let t=Math.random()*Math.PI*2;return new h(Math.cos(t),Math.sin(t))}static fromCircle(t,e,s){return new h(t.x+e*Math.sin(s),t.y+e*Math.cos(s))}static fromCopy(t){return this.zero().copy(t)}static zero(){return new h(0,0)}static NaN(){return new h(NaN,NaN)}static fromCircumcenter(t,e,s){const r=t.squareSum(),i=e.squareSum(),n=s.squareSum();let o=2*(t.x*(e.y-s.y)+e.x*(s.y-t.y)+s.x*(t.y-e.y));if(o<1e-6)return h.NaN();let a=(r*(e.y-s.y)+i*(s.y-t.y)+n*(t.y-e.y))/o,l=(r*(s.x-e.x)+i*(t.x-s.x)+n*(e.x-t.x))/o;return new h(a,l)}static getSign(t,e,s){return(t.x-s.x)*(e.y-s.y)-(e.x-s.x)*(t.y-s.y)}to3D(){return new n(this.x,this.y,0)}set(t,e){return this.x=t,this.y=e,this}roughlyEquals(t,e){return Math.abs(this.x-t.x)<e&&Math.abs(this.y-t.y)<e}equals(t){return t.x===this.x&&t.y===this.y}toString(){return`Vector2(${this.x}, ${this.y})`}clone(){return new h(this.x,this.y)}copy(t){return this.x=t.x,this.y=t.y,this}add(t){return this.x+=t.x,this.y+=t.y,this}added(t){return new h(this.x+t.x,this.y+t.y)}addn(t,e){return this.x+=t,this.y+=e,this}sub(t){return this.x-=t.x,this.y-=t.y,this}subbed(t){return new h(this.x-t.x,this.y-t.y)}mul(t){return this.x*=t.x,this.y*=t.y,this}scale(t){return this.x*=t,this.y*=t,this}scaled(t){return new h(this.x*t,this.y*t)}divVector(t){return this.x/=t.x,this.y/=t.y,this}div(t){return this.x/=t,this.y/=t,this}dived(t){return new h(this.x/t,this.y/t)}minimum(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this}maximum(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this}clampScalar(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this}clampLength(t,e){const s=this.length();return this.div(s||1).scale(Math.max(t,Math.min(e,s)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}squareSum(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.lengthSquared())}lengthSquared(){return this.x*this.x+this.y*this.y}manhat(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.div(this.length()||1)}normalized(){return this.dived(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}disTo(t){return Math.sqrt(this.disToSquared(t))}disToSquared(t){let e=this.x-t.x,s=this.y-t.y;return e*e+s*s}disToManhat(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)}setLength(t){return this.normalize().scale(t)}lerp(t,e){return new h(this.x+(t.x-this.x)*e,this.y+(t.y-this.y)*e)}sign(t,e){return(this.x-e.x)*(t.y-e.y)-(t.x-e.x)*(this.y-e.y)}projectOnVector(t){const e=t.lengthSquared();if(0===e)return this.set(0,0);const s=t.dot(this)/e;return this.copy(t).scale(s)}}class a extends r{constructor(t){super(t,2)}static fromList(t){let e=t.length,s=new a(e);for(let e=0;e<t.length;e++)s.data[2*e]=t[e].x,s.data[2*e+1]=t[e].y;return s}forEach(t){for(let e=0;e<this.count();e++){let s=this.getVector(e);t(s,e),this.setVector(e,s)}return this}map(t){let e=this.clone();for(let s=0;s<this.count();s++){let r=this.getVector(s),i=t(r,s);i instanceof h?e.setVector(s,i):e.setVector(s,r)}return e}setVector(t,e){this.data[t*this._width+0]=e.x,this.data[t*this._width+1]=e.y}getVector(t){return new h(this.data[t*this._width+0],this.data[t*this._width+1])}toList(){let t=[];for(let e=0;e<this._height;e++)t.push(this.getVector(e));return t}to3D(){let t=new l(this.count());for(let e=0;e<this.count();e++){let s=this.getRow(e);t.setRow(e,[s[0],s[1],0])}return t}clone(){let t=new a(this._height);for(let e=0;e<this.data.length;e++)t.data[e]=this.data[e];return t}}class l extends r{constructor(t){super(t,3)}static fromList(t){let e=t.length,s=new l(e);for(let e=0;e<t.length;e++)s.data[3*e]=t[e].x,s.data[3*e+1]=t[e].y,s.data[3*e+2]=t[e].z;return s}static fromNative(t){let e=t.length,s=new l(e);for(var r=0;r<t.length;r++)for(var i=0;i<t[0].length;i++)s.set(r,i,t[r][i]);return s}fillFromList(t){for(let e=0;e<t.length;e++)this.data[3*e]=t[e].x,this.data[3*e+1]=t[e].y,this.data[3*e+2]=t[e].z}forEach(t){for(let e=0;e<this.count();e++){let s=this.getVector(e);s=t(s,e),s instanceof n&&this.setVector(e,s)}return this}take(t){const e=t.length;let s=new l(e);for(let r=0;r<e;r++){let e=t[r];s.setVector(r,this.getVector(e))}return s}map(t){let e=this.clone();for(let s=0;s<this.count();s++){let r=this.getVector(s),i=t(r,s);i instanceof n?e.setVector(s,i):e.setVector(s,r)}return e}mapWith(t,e){return super.mapWith(t,e)}setVector(t,e){this.data[t*this._width+0]=e.x,this.data[t*this._width+1]=e.y,this.data[t*this._width+2]=e.z}getVector(t){return new n(this.data[t*this._width+0],this.data[t*this._width+1],this.data[t*this._width+2])}toList(){let t=[];for(let e=0;e<this._height;e++)t.push(this.getVector(e));return t}transform(t){for(let e=0;e<this._height;e++){let s=this.getVector(e);s=t.multiplyVector(s),this.setVector(e,s)}return this}to2D(){let t=new a(this._height);for(let e=0;e<this._height;e++)for(let s=0;s<2;s++)t.set(e,s,this.get(e,s));return t}clone(){let t=new l(this._height);for(let e=0;e<this.data.length;e++)t.data[e]=this.data[e];return t}mean(){let t=n.zero(),e=this.count();for(let s=0;s<e;s++)t.x+=this.data[3*s],t.y+=this.data[3*s+1],t.z+=this.data[3*s+2];return t.scale(1/e)}average(){return this.mean()}closestId(t){let e=1/0,s=-1;return this.forEach(((r,i)=>{let n=t.disToSquared(r);n<e&&(e=n,s=i)})),s}closestIds(t,e){let s=[];for(let r=0;r<e;r++){let e=1/0,r=-1;this.forEach(((i,n)=>{if(s.includes(r))return;let o=t.disToSquared(i);o<e&&(e=o,r=n)})),s.push(r)}return s}}var u,d,c;!function(t){t[t.Invalid=0]="Invalid",t[t.Points=1]="Points",t[t.Lines=2]="Lines",t[t.Triangles=3]="Triangles",t[t.Quads=4]="Quads"}(u||(u={})),(c=d||(d={}))[c.None=0]="None",c[c.Vertex=1]="Vertex",c[c.Face=2]="Face",c[c.MultiVertex=3]="MultiVertex";class g{constructor(t,e,s,r,n){this._normKind=d.None,this.color=[1,1,1,1],this.linecolor=[1,1,1,1],this.mesh=y.newEmpty(t,r,3),this.norms=new l(e),this.uvs=new a(s),this.ambi=new Float32Array(t),this.texture=n,this.position=i.newIdentity()}static new(t,e,s,r,i){return new g(t,e,s,r,i)}static fromMesh(t){let e=new g(t.verts.count(),0,0,t.links.count());return e.mesh.verts.data=t.verts.data,e.mesh.links.data=t.links.data,e}static fromData(t,e,s,r){let i=new g(t.length/3,e.length/3,s.length/2,r.length/3);return i.mesh.verts.fillWith(t),i.mesh.links.fillWith(r),i.norms.fillWith(e),i.uvs.fillWith(s),i}static fromGraph(t){let e=t.toMesh(),s=g.fromMesh(e);return s.norms=l.fromList(t.allNorms()),s._normKind=d.Vertex,s}transform(t){for(let e=0;e<this.mesh.verts.count();e++){let s=this.mesh.verts.getVector(e),r=this.norms.getVector(e);this.mesh.verts.setVector(e,t.multiplyVector(s)),this.norms.setVector(e,t.multiplyVector(r))}}getAdjacentFaces(t){let e=[],s=this.mesh.links.count();for(let r=0;r<s;r++)this.mesh.links.getRow(r).includes(t)&&e.push(r);return e}getFaceVertices(t){return this.mesh.getLinkVerts(t)}getType(){return this.mesh.getType()}getNormalType(){return this._normKind}setTexture(t){this.texture=t}setUvs(t){t instanceof Float32Array?this.uvs.data=t:this.uvs=t}exportToObj(t){throw"todo"}calculateFaceNormals(){if(this.getType()!=u.Triangles)return console.error("can only calculate normals from triangular meshes"),void(this.norms=new l(0));let t=this.mesh.calculateFaceNormals();this.norms=l.fromList(t),this._normKind=d.Face}calculateVertexNormals(){let t=this.mesh.calculateVertexNormals();this.norms=l.fromList(t),this._normKind=d.Vertex}calculateMultiVertexNormals(){this._normKind=d.MultiVertex,this.calculateFaceNormals();let t=new l(this.mesh.verts.count());this.mesh.verts.forEach(((e,s)=>{let r=this.getAdjacentFaces(s);t.setVector(s,this.norms.take(r).average())})),this.norms=t}}class m{static sum(t){let e=0;for(let s=0;s<t.length;s++)e+=t[s];return e}static mean(t){return this.sum(t)/t.length}static variance(t){let e=t.length,s=this.mean(t),r=0;for(let i=0;i<e;i++)r+=Math.pow(t[i]-s,2);return r/(e-1)}static deviation(t){return Math.pow(this.variance(t),.5)}static covariance(t,e){if(t.length!=e.length)throw"this is not how covariance works...";let s=t.length,r=this.mean(t),i=this.mean(e),n=0;for(let o=0;o<s;o++)n+=(t[o]-r)*(e[o]-i);return n/(s-1)}static cov(t){let e=t._width,s=new r(e,e),i=Array(e);for(let s=0;s<e;s++)i[s]=t.getColumn(s);for(let t=0;t<e;t++)for(let r=t;r<e;r++){let e=this.covariance(i[t],i[r]);s.set(t,r,e),s.set(r,t,e)}return s}static eig(t){let e=this.svd(t);return[e[1],e[2]]}static svd(t){var e=Math.pow(2,-52),s=1e-64/e,i=0,n=0,o=0,h=0,a=0,l=t.clone().toNative(),u=l.length,d=l[0].length;if(u<d)throw"Need more rows than columns";var c=new Array(d),g=new Array(d);for(n=0;n<d;n++)c[n]=g[n]=0;var m=function t(e,s,r=0){let i,n=e[r],o=Array(n);if(r===e.length-1){for(i=n-2;i>=0;i-=2)o[i+1]=s,o[i]=s;return-1===i&&(o[0]=s),o}for(i=n-1;i>=0;i--)o[i]=t(e,s,r+1);return o}([d,d],0);function f(t,e){return(t=Math.abs(t))>(e=Math.abs(e))?t*Math.sqrt(1+e*e/t/t):0==e?t:e*Math.sqrt(1+t*t/e/e)}var w,p=0,x=0,y=0,v=0,E=0,M=0,_=0;for(n=0;n<d;n++){for(c[n]=x,_=0,a=n+1,o=n;o<u;o++)_+=l[o][n]*l[o][n];if(_<=s)x=0;else for(p=l[n][n],x=Math.sqrt(_),p>=0&&(x=-x),y=p*x-_,l[n][n]=p-x,o=a;o<d;o++){for(_=0,h=n;h<u;h++)_+=l[h][n]*l[h][o];for(p=_/y,h=n;h<u;h++)l[h][o]+=p*l[h][n]}for(g[n]=x,_=0,o=a;o<d;o++)_+=l[n][o]*l[n][o];if(_<=s)x=0;else{for(p=l[n][n+1],x=Math.sqrt(_),p>=0&&(x=-x),y=p*x-_,l[n][n+1]=p-x,o=a;o<d;o++)c[o]=l[n][o]/y;for(o=a;o<u;o++){for(_=0,h=a;h<d;h++)_+=l[o][h]*l[n][h];for(h=a;h<d;h++)l[o][h]+=_*c[h]}}(E=Math.abs(g[n])+Math.abs(c[n]))>v&&(v=E)}for(n=d-1;-1!=n;n+=-1){if(0!=x){for(y=x*l[n][n+1],o=a;o<d;o++)m[o][n]=l[n][o]/y;for(o=a;o<d;o++){for(_=0,h=a;h<d;h++)_+=l[n][h]*m[h][o];for(h=a;h<d;h++)m[h][o]+=_*m[h][n]}}for(o=a;o<d;o++)m[n][o]=0,m[o][n]=0;m[n][n]=1,x=c[n],a=n}for(n=d-1;-1!=n;n+=-1){for(a=n+1,x=g[n],o=a;o<d;o++)l[n][o]=0;if(0!=x){for(y=l[n][n]*x,o=a;o<d;o++){for(_=0,h=a;h<u;h++)_+=l[h][n]*l[h][o];for(p=_/y,h=n;h<u;h++)l[h][o]+=p*l[h][n]}for(o=n;o<u;o++)l[o][n]=l[o][n]/x}else for(o=n;o<u;o++)l[o][n]=0;l[n][n]+=1}for(e*=v,h=d-1;-1!=h;h+=-1)for(var b=0;b<50;b++){var V=!1;for(a=h;-1!=a;a+=-1){if(Math.abs(c[a])<=e){V=!0;break}if(Math.abs(g[a-1])<=e)break}if(!V){i=0,_=1;var A=a-1;for(n=a;n<h+1&&(p=_*c[n],c[n]=i*c[n],!(Math.abs(p)<=e));n++)for(y=f(p,x=g[n]),g[n]=y,i=x/y,_=-p/y,o=0;o<u;o++)E=l[o][A],M=l[o][n],l[o][A]=E*i+M*_,l[o][n]=-E*_+M*i}if(M=g[h],a==h){if(M<0)for(g[h]=-M,o=0;o<d;o++)m[o][h]=-m[o][h];break}if(b>=49)throw"Error: no convergence.";for(v=g[a],x=f(p=(((E=g[h-1])-M)*(E+M)+((x=c[h-1])-(y=c[h]))*(x+y))/(2*y*E),1),p=p<0?((v-M)*(v+M)+y*(E/(p-x)-y))/v:((v-M)*(v+M)+y*(E/(p+x)-y))/v,i=1,_=1,n=a+1;n<h+1;n++){for(x=c[n],E=g[n],y=_*x,x*=i,M=f(p,y),c[n-1]=M,p=v*(i=p/M)+x*(_=y/M),x=-v*_+x*i,y=E*_,E*=i,o=0;o<d;o++)v=m[o][n-1],M=m[o][n],m[o][n-1]=v*i+M*_,m[o][n]=-v*_+M*i;for(M=f(p,y),g[n-1]=M,p=(i=p/M)*x+(_=y/M)*E,v=-_*x+i*E,o=0;o<u;o++)E=l[o][n-1],M=l[o][n],l[o][n-1]=E*i+M*_,l[o][n]=-E*_+M*i}c[a]=0,c[h]=p,g[h]=v}for(n=0;n<g.length;n++)g[n]<e&&(g[n]=0);for(n=0;n<d;n++)for(o=n-1;o>=0;o--)if(g[o]<g[n]){for(i=g[o],g[o]=g[n],g[n]=i,h=0;h<l.length;h++)w=l[h][n],l[h][n]=l[h][o],l[h][o]=w;for(h=0;h<m.length;h++)w=m[h][n],m[h][n]=m[h][o],m[h][o]=w;n=o}return[r.fromNative(l),new Float32Array(g),r.fromNative(m)]}}class f{constructor(t){this._matrix=t}static fromPN(t,s){let r=s.cross(n.unitX());r.length()<e.TOLERANCE&&(r=s.cross(n.unitY()));let i=r.normalize(),o=s.cross(i).normalize(),h=f.planeMatrixFromVecs(t,i,o,s);return new f(h)}static fromPVV(t,e,s){let r=e.clone().cross(s).normalize(),i=t.clone(),n=e.normalize(),o=e.clone().cross(r),h=f.planeMatrixFromVecs(i,n,o,r);return new f(h)}static from3pt(t,e,s){let r=e.clone().sub(t),i=s.clone().sub(t);return this.fromPVV(t,r,i)}static WorldXY(){return f.from3pt(n.zero(),n.unitX(),n.unitY())}static WorldYZ(){return f.from3pt(n.zero(),n.unitY(),n.unitZ())}static WorldXZ(){return f.from3pt(n.zero(),n.unitX(),n.unitZ())}static fromLeastSquares(t){let e=t.mean(),s=m.cov(t),[r,i]=m.eig(s);console.log(r);let o=n.fromArray(i.getColumn(0)),h=n.fromArray(i.getColumn(1));return f.fromPVV(e,o,h)}static fromXYLeastSquares(t){let e=t.mean();return f.WorldXY().transform(i.newTranslation(e.x,e.y,e.z))}static planeMatrixFromVecs(t,e,s,r){return new i([e.x,e.y,e.z,0,s.x,s.y,s.z,0,r.x,r.y,r.z,0,t.x,t.y,t.z,1])}get ihat(){return n.fromArray(this._matrix.getRow(0))}get jhat(){return n.fromArray(this._matrix.getRow(1))}get khat(){return n.fromArray(this._matrix.getRow(2))}get center(){return n.fromArray(this._matrix.getRow(3))}get matrix(){return this._matrix.clone()}get normal(){return this.khat}get d(){return this.closestPoint(n.zero())[1]}set ihat(t){this._matrix.setRow(0,[t.x,t.y,t.z,0])}set jhat(t){this._matrix.setRow(1,[t.x,t.y,t.z,0])}set khat(t){this._matrix.setRow(2,[t.x,t.y,t.z,0])}set center(t){this._matrix.setRow(3,[t.x,t.y,t.z,1])}set matrix(t){this._matrix=t}get inverse(){return this._matrix.inverse()}setPosition(t){this.center=t}setNormal(t){this.khat=t}clone(){return new f(this._matrix.clone())}transform(t){return this._matrix=this._matrix.multiply(t),this}moveTo(t){return this.center=t,this}pullToPlane(t){return this.inverse.multiplyVector(t)}pushToWorld(t){return this.matrix.multiplyVector(t)}closestPoint(t){let e=this.pullToPlane(t),s=e.z;return e.z=0,[this.pushToWorld(e),s]}rotateVector(t,e){let s=this.pullToPlane(t);return s=i.newAxisRotation(this.normal,e).multiplyVector(s),this.pushToWorld(s)}}class w{constructor(){this.data=new Map}stringify(t){return t.toString()}set(t,e){return this.data.set(this.stringify(t),e)}has(t){return this.data.has(this.stringify(t))}get(t){return this.data.get(this.stringify(t))}}class p{constructor(){this.verts=[],this.edges=[]}static new(){return new p}static fromMesh(t){let e=p.new(),s=t.calculateVertexNormals();t.verts.forEach(((t,r)=>{e.addVert(t,s[r])}));let r=t.getType();if(r==u.Invalid||r==u.Points)return e;new w;let i=t.links._width;return t.links.forEachRow(((t,s)=>{for(let s=0;s<i;s++){let r=(s+1)%i,n=t[s],o=t[r];-1!=n&&-1!=o&&e.addEdgeIfNew(n,o)}})),e}clone(){throw new Error("not yet implemented...")}transform(t){for(let e=0;e<this.verts.length;e++){let s=this.verts[e];s.pos=t.multiplyVector(s.pos)}}print(){console.log("graph"),console.log("--------"),console.log(`${this.verts.length} verts: `);for(let t=0;t<this.verts.length;t++){let e=this.verts[t];console.log(`v(${t}) | edge: ${e.edge}, data: ${e.pos.toString()} normal: ${e.normal.toString()}`)}console.log("--------"),console.log(`${this.edges.length} edges:  `);for(let t=0;t<this.edges.length;t++){let e=this.edges[t];console.log(`e(${t}) | vert: ${e.vert}, twin: ${e.twin}, next: ${e.next}, dead ${e.dead}`)}console.log("--------")}toMesh(){return y.fromGraph(this)}toLines(){return y.newLines(this.allVertPositions(),this.allUniqueEdgeVerts())}toRenderable(){return g.fromGraph(this)}allNorms(){let t=[];return this.verts.forEach((e=>{t.push(e.normal)})),t}allVertPositions(){let t=[];return this.verts.forEach((e=>{t.push(e.pos)})),t}allUniqueEdges(){let t=[],e=this.edges.length/2;for(let s=0;s<e;s++){let e=2*s,r=2*s+1,i=this.getEdge(e),n=this.getEdge(r);i.dead||n.dead||t.push(e)}return t}allUniqueEdgeVerts(){let t=[],e=this.edges.length/2;for(let s=0;s<e;s++){let e=2*s,r=2*s+1,i=this.getEdge(e),n=this.getEdge(r);i.dead||n.dead||t.push(i.vert,n.vert)}return t}allEdgeVerts(){let t=[];return this.edges.forEach(((e,s)=>{if(e.dead)return;let r=e.vert,i=this.getEdge(e.twin).vert;r<i&&(t.push(r),t.push(i))})),t}allVertLoops(){throw"TODO"}allVertLoopsAsInts(){let t=[],e=new Set;this.edges.forEach(((t,s)=>{t.dead||e.add(s)}));let s=0;const r=this.edges.length;for(;e.size>0;){let i=[],n=e.entries().next().value[0],o=n;do{if(s>r)throw"topology is corrupt!";s+=1;let t=this.getEdge(n);e.delete(n),i.push(t.vert),n=t.next}while(n!=o);t.push(i)}return t}getLoop(t){let e=[],s=0;const r=this.edges.length;let i=t;do{if(s>r)throw"topology is corrupt!";s+=1;let i=this.getEdge(t);e.push(t),t=i.next}while(t!=i);return e}getVertexPos(t){if(t<0||t>=this.verts.length)throw"out of range";return this.verts[t].pos}getVertexNormal(t){if(t<0||t>=this.verts.length)throw"out of range";return this.verts[t].normal}getVertexCount(){return this.verts.length}getHalfEdgeCount(){return this.edges.length}changeVertex(t,e,s){let r=this.verts[t];r.pos=e,r.normal=s}getVert(t){if(t<0||t>=this.verts.length)throw"out of range";return this.verts[t]}getEdge(t){return(t<0||t>=this.edges.length)&&console.error("out of range"),this.edges[t]}getEdgeIndexBetween(t,e){let s=this.getEdgeBetween(t,e);if(s)return this.getEdgeIndex(s)}getEdgeBetween(t,e){let s=this.getVertEdgeFan(t);for(let t=0;t<s.length;t++)if(this.getEdge(s[t].twin).vert==e)return s[t]}getVertEdgeFan(t){let e=[],s=this.verts[t].edge,r=s;if(-1==s)return e;let i=0;for(;;){if(i>this.verts.length)throw this.print(),console.log("fan: ",e),"nope";i+=1;let t=this.getEdge(s),n=this.getEdgeTwin(s);if(e.push(t),s=n.next,s==r)break}return e}getLoopsAdjacentToEdge(t){let e=[];return e.push(this.getLoop(t)),e.push(this.getLoop(this.getEdge(t).twin)),e}getVertNeighbors(t){let e=[];return this.getVertEdgeFan(t).forEach((t=>{e.push(this.getEdge(t.twin).vert)})),e}getEdgeIndex(t){return this.getEdge(t.twin).twin}getEdgeTwin(t){return this.edges[this.edges[t].twin]}hasEdge(t,e){return this.getVertNeighbors(t).includes(e)}addVert(t,e){return this.verts.push({pos:t,edge:-1,normal:e,dead:!1}),this.verts.length-1}removeVert(t){throw"TODO FIGURE OUT NULL & REMOVAL"}addEdgeIfNew(t,e){return!this.hasEdge(t,e)&&(this.addEdge(t,e),!0)}addEdge(t,e){let s=this.edges.length,r=s+1;this.edges.push({next:-1,twin:r,vert:t,dead:!1}),this.edges.push({next:-1,twin:s,vert:e,dead:!1}),this.addEdgeToDisk(t,s),this.addEdgeToDisk(e,r)}deleteEdgeByIndex(t){this.deleteEdge(this.getEdge(t))}deleteEdge(t){let e=this.getEdge(t.twin);t.dead=!0,e.dead=!0,this.deleteEdgeFromDisk(t),this.deleteEdgeFromDisk(e)}getDiskPositions(t){let e=this.getEdge(t),s=this.getVert(e.vert),r=this.getEdgeTwin(t),i=this.verts[r.vert],o=s.pos.subbed(i.pos),h=[];h.push(o);let a=this.getVertEdgeFan(e.vert),l=[];for(let e=0;e<a.length;e++){let s=a[e];this.getEdgeIndex(s)==t||l.push(s)}if(0==l.length)return[t,t];if(1==l.length){let t=l[0];return[this.getEdgeIndex(t),this.getEdgeIndex(t)]}for(let t=0;t<l.length;t++){let e=l[t],r=this.getEdge(e.twin),i=this.verts[r.vert],n=s.pos.subbed(i.pos);h.push(n)}let u=f.fromPN(s.pos,s.normal),d=u.ihat,c=u.jhat,g=n.calculateWheelOrder(h,d,c),m=-1,w=-1;for(let t=0;t<g.length;t++){let e=(t+1)%g.length,s=(t+2)%g.length;if(0==g[e]){m=g[t],w=g[s];break}}let p=l[w-1],x=l[m-1];return[this.getEdgeIndex(p),this.getEdgeIndex(x)]}addEdgeToDisk(t,e){let s=this.getVert(t),r=this.getEdgeTwin(e);if(-1==s.edge)s.edge=e,r.next=e;else{let[t,s]=this.getDiskPositions(e),[i,n]=[this.getEdge(t),this.getEdge(s)];this.getEdge(i.twin).next=e,r.next=this.getEdgeIndex(n)}}deleteEdgeFromDisk(t){let e=this.getEdgeIndex(t),s=this.getVert(t.vert),[r,i]=this.getDiskPositions(e);if(r==e)return void(s.edge=-1);let[n,o]=[this.getEdge(r),this.getEdge(i)];this.getEdge(n.twin).next=i,s.edge==e&&(s.edge=i)}splitEdge(t,e,s){let r=this.getEdgeBetween(t,e);if(!r)throw new Error(`No Edge found between ${t} and ${e}`);this.getEdge(r.twin);let i=this.getVert(t),o=this.getVert(e),h=n.fromLerp(i.pos,o.pos,s),a=n.fromLerp(i.normal,o.normal,s),l=this.addVert(h,a);return this.getVert(l),this.deleteEdge(r),this.addEdge(t,l),this.addEdge(l,e),l}subdivide(){let t=this.allEdgeVerts(),e=this.allVertLoopsAsInts(),s=new w,r=t.length/2,i=new Array(r);for(let e=0;e<r;e++){let r=t[2*e],n=t[2*e+1],o=this.splitEdge(r,n,.5);i[e]=o,s.set([r,n],o),s.set([n,r],o)}for(let t=0;t<e.length;t++){let r=e[t],i=new Array(r.length);for(let t=0;t<r.length;t++){let e=(t+1)%r.length,n=r[t],o=r[e];i[t]=s.get([n,o])}for(let t=0;t<r.length;t++){let e=(t+1)%r.length;this.addEdge(i[t],i[e])}}}subdivideQuad(){let t=this.allEdgeVerts(),e=this.allVertLoopsAsInts(),s=new w,r=t.length/2;for(let e=0;e<r;e++){let r=t[2*e],i=t[2*e+1],n=this.splitEdge(r,i,.5);s.set([r,i],n),s.set([i,r],n)}for(let t=0;t<e.length;t++){let r=e[t],i=n.zero();for(let t=0;t<r.length;t++)i.add(this.getVertexPos(r[t]));i.scale(1/r.length);let o=x(r.map((t=>this.getVertexPos(t)))),h=this.addVert(i,o);for(let t=0;t<r.length;t++){let e=(t+1)%r.length,i=r[t],n=r[e],o=s.get([i,n]);this.addEdge(h,o)}}}forEveryEdgeVerts(t){let e=this.allUniqueEdgeVerts(),s=e.length/2;for(let r=0;r<s;r++){let s=this.getVert(e[2*r]),i=this.getVert(e[2*r+1]);t(s.pos,i.pos)}}}function x(t){let s=t.length;if(s<3)throw"cannot get face planar with 2 or less edges";n.zero();let r=t[1].subbed(t[0]),i=t[2].subbed(t[1]);for(let n=1;n<s;n++){if(Math.abs(r.dot(i))>e.TOLERANCE)return r.cross(i);{let e=(n+1)%s;i=t[(n+2)%s].subbed(t[e])}}throw"get planar face failed..."}class y{constructor(t,e){this.verts=t,this.links=e}clone(){return new y(this.verts.clone(),this.links.clone())}static new(t,e){return new y(t,e)}static fromLists(e,s){return new y(l.fromList(e),t.fromList(s,3))}static newEmpty(e,s,r){return new y(new l(e),new t(s,r))}static newLines(e,s){let r=l.fromList(e),i=t.fromList(s,2);return new y(r,i)}static zero(){return new y(new l(0),new t(0,0))}static fromJoin(e){let s=0,r=0;for(let t of e)s+=t.verts.count(),r+=t.links.count();let i=new l(s),n=new t(r,3),o=0,h=0;for(let t of e){for(let e=0;e<t.verts.count();e++)i.setVector(o+e,t.verts.getVector(e));for(let e=0;e<t.links.count();e++){let s=t.links.getRow(e);for(let t=0;t<s.length;t++)s[t]=s[t]+o;n.setRow(h+e,s)}o+=t.verts.count(),h+=t.links.count()}return new y(i,n)}static fromRect(t){let e=t.getCorners(),s=[];s.push(...E(v[0]));let r=new g(4,0,0,2);return r.mesh.verts.fillFromList(e),r.mesh.links.setData(s),r.setUvs(new Float32Array([0,0,0,1,1,0,1,1])),r}static newQuad(t){let e=[...E(v[0])];return this.fromLists(t,e)}static newOct(t){let e=[];for(let t of v)e.push(...E(t));return this.fromLists(t,e)}static fromCube(t){let e=t.getCorners();return y.newOct(e)}static newIcosahedron(t=1){let e=new p,s=t,r=s*((1+Math.pow(5,.5))/2),i=t=>{e.addVert(t,t)};i(new n(-s,-r,0)),i(new n(s,-r,0)),i(new n(-s,r,0)),i(new n(s,r,0)),i(new n(0,-s,-r)),i(new n(0,s,-r)),i(new n(0,-s,r)),i(new n(0,s,r)),i(new n(-r,0,-s)),i(new n(-r,0,s)),i(new n(r,0,-s)),i(new n(r,0,s));let o=(t,s)=>{e.addEdge(t,s)};for(let t=0;t<12;t+=4){o(t+0,t+1),o(t+2,t+3);let e=(t+4)%12;o(t+0,e+2),o(t+0,e+0),o(t+1,e+2),o(t+1,e+0),o(t+2,e+3),o(t+2,e+1),o(t+3,e+3),o(t+3,e+1)}return this.fromGraph(e)}static newSphere(e,s,r,i){let o=r*i+2,h=new l(o),a=function(t,r){h.setVector(t,r.scale(s).add(e))};a(0,new n(0,0,1));for(let t=0;t<r;t++)for(let e=0;e<i;e++){let s=Math.PI*(t+1)/(r+1),o=2*Math.PI*e/i,h=Math.sin(s)*Math.cos(o),l=Math.sin(s)*Math.sin(o),u=Math.cos(s);a(1+t*i+e,new n(h,l,u))}a(o-1,new n(0,0,-1));let u=i*r*2,d=new t(u,3);d.fill(-1);let c=function(t,e){d.setRow(t,e)};for(let t=0;t<i;t++)c(t,[0,t+1,(t+1)%i+1]);for(let t=0;t<r-1;t++){let e=i*t+1,s=e+i;for(let r=0;r<i;r++){let n=e+(r+1)%i,o=s+r,h=s+(r+1)%i,a=i+i*t*2+2*r;c(a,[e+r,o,n]),c(a+1,[o,h,n])}}for(let t=0;t<i;t++){let e=o-i-1;c(u-i+t,[o-1,e+(t+1)%i,e+t])}return new y(h,d)}static newCylinder(e,s,r,i){let o=s.subbed(e),h=2*i+2,a=2*(h-2),u=new l(h),d=function(t,e){u.setVector(t,e)},c=f.fromPN(e,o),g=f.fromPN(s,o);d(0,e);for(let t=0;t<i;t++){let e=new n(Math.cos(2*Math.PI*t/i),Math.sin(2*Math.PI*t/i),0).scale(r);e=c.matrix.multiplyVector(e),d(t+1,e)}let m=h/2;for(let t=0;t<i;t++){let e=new n(Math.cos(2*Math.PI*t/i),Math.sin(2*Math.PI*t/i),0).scale(r);e=g.matrix.multiplyVector(e),d(m+t,e)}d(h-1,s);let w=new t(a,3);w.fill(-1);let p=function(t,e){w.setRow(t,e)};for(let t=0;t<i;t++){let e=1+t,s=1+(t+1)%i,r=h-1,n=m+t,o=m+(t+1)%i;p(4*t,[0,s,e]),p(4*t+1,[e,s,n]),p(4*t+2,[s,o,n]),p(4*t+3,[r,n,o])}return new y(u,w)}static newCone(e,s,r,i){let o=i+2,h=2*i,a=new l(o),u=function(t,s){a.setVector(t,s.add(e))},d=new t(h,3);d.fill(-1);let c=function(t,e){d.setRow(t,e)};u(0,new n(0,0,0));for(let t=0;t<i;t++)u(t+1,new n(Math.cos(2*Math.PI*t/i),Math.sin(2*Math.PI*t/i),0).scale(s));u(o-1,new n(0,0,r));for(let t=0;t<i;t++){let e=o-1,s=1+t,r=1+(t+1)%i;c(2*t,[0,r,s]),c(2*t+1,[s,r,e])}return new y(a,d)}static fromGraph(e){let s=l.fromList(e.allVertPositions()),r=e.allVertLoopsAsInts(),i=new t(r.length,3);return r.forEach(((t,e)=>{3==t.length?i.setRow(e,t):console.log("cant convert loop")})),y.new(s,i)}toLines(){const e=e=>{let s=this.links.count()*e,r=new t(s,2);for(let t=0;t<this.links.count();t++)for(let s=0;s<e;s++){let i=(s+1)%e,n=t*e+s;r.set(n,0,this.links.get(t,s)),r.set(n,1,this.links.get(t,i))}return r};let s=this.getType();if(s==u.Lines)return this.clone();if(s==u.Triangles){let t=e(3);return y.new(this.verts.clone(),t)}if(s==u.Quads){let t=e(4);return y.new(this.verts.clone(),t)}return console.warn("cannot convert to lines"),y.newEmpty(0,0,0)}toRenderable(){return g.fromMesh(this)}toGraph(){return p.fromMesh(this)}getType(){return this.links._width==u.Points?u.Points:this.links._width==u.Lines?u.Lines:this.links._width==u.Triangles?u.Triangles:this.links._width==u.Quads?u.Quads:u.Invalid}getLinkVerts(t){let e=new l(this.links._width);return this.links.getRow(t).forEach(((t,s)=>{e.setVector(s,this.verts.getVector(t))})),e}calculateFaceNormals(){let t=[];if(this.getType()!=u.Triangles)return console.error("can only calculate normals from triangular meshes"),t;let e=this.links.count();for(let s=0;s<e;s++){let e=this.getLinkVerts(s).toList(),r=e[1].subbed(e[0]).cross(e[2].subbed(e[0])).normalize();t.push(r)}return t}calculateVertexNormals(){let t=this.links.count(),e=this.calculateFaceNormals(),s=new l(this.verts.count());for(let r=0;r<t;r++){let t=e[r];this.links.getRow(r).forEach((e=>{let r=s.getVector(e);s.setVector(e,r.add(t))}))}let r=s.toList();for(let t=0;t<r.length;t++)r[t].normalize();return r}}const v=[[0,1,3,2],[4,0,2,6],[1,0,4,5],[1,5,7,3],[2,3,7,6],[5,4,6,7]];function E(t){return[t[0],t[2],t[1],t[0],t[3],t[2]]}class M{static generateGaussianKernel(t,e){var s,i,n,o,h,a,l,u,d,c,g,m,f,w,p,x;for(h=t,o=new r(e,e),a=0,i=d=0,f=e-1;0<=f?d<=f:d>=f;i=0<=f?++d:--d)for(l=-(e-1)/2+i,n=c=0,w=e-1;0<=w?c<=w:c>=w;n=0<=w?++c:--c)u=-(e-1)/2+n,s=1/(2*Math.PI*h*h)*Math.pow(2.718,-(l*l+u*u)/(2*h*h)),o.set(i,n,s),a+=s;for(i=g=0,p=e-1;0<=p?g<=p:g>=p;i=0<=p?++g:--g)for(n=m=0,x=e-1;0<=x?m<=x:m>=x;n=0<=x?++m:--m)o.set(i,n,o.get(i,n)/a);return o}}M.SmoothKernel=new r(3,3,[1,1,1,1,1,1,1,1,1]).forEachValue((t=>1*t/9)),M.SmoothKernel5=new r(5,5,[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]).forEachValue((t=>1*t/25)),M.Gauss5=new r(5,5,[2,4,5,4,2,4,9,12,9,4,5,12,15,12,5,4,9,12,9,4,2,4,5,4,2]).forEachValue((t=>1*t/159)),M.TestKernel=new r(3,3,[1,0,-1,0,0,0,-1,0,1]),M.SobelLeft=new r(3,3,[1,2,1,0,0,0,-1,-2,-1]),M.SobelRight=new r(3,3,[-1,-2,-1,0,0,0,1,2,1]),M.SobelUp=new r(3,3,[1,0,-1,2,0,-2,1,0,-1]),M.SobelDown=new r(3,3,[-1,0,1,-2,0,2,-1,0,1]);class _{constructor(t,e){this.verts=t,this.links=null==e?function(t){let e=new Uint16Array(t);for(let s=0;s<t;s++)e[s]=s;return e}(t.count()):e}static fromLines(t){let e=(s=t)instanceof a||s instanceof l?s:s[0]instanceof h?a.fromList(s):l.fromList(s);var s;return new _(e)}static fromMesh(t,e=!1){let s=t.mesh,r=6*s.links.count(),i=new Uint16Array(r);for(let t=0;t<s.links.count();t++){let e=6*t;i[e]=s.links.get(t,0),i[e+1]=s.links.get(t,1),i[e+2]=s.links.get(t,1),i[e+3]=s.links.get(t,2),i[e+4]=s.links.get(t,2),i[e+5]=s.links.get(t,0)}return new _(e?t.uvs:s.verts,i)}static fromGrid(t,e,s){let r=(e-1)*s/2,i=new l(4*e);for(let t=0;t<e;t++){let e=s*t-r;i.setVector(2*t,new n(e,-r,0)),i.setVector(2*t+1,new n(e,r,0))}for(let t=0;t<e;t++)i.setVector(2*e+2*t,new n(-r,s*t-r,0)),i.setVector(2*e+2*t+1,new n(r,s*t-r,0));return i.forEach((e=>t.pushToWorld(e))),new _(i)}static fromPlane(t){let s=e.PLANE_RENDER_LINECOUNT,r=e.PLANE_RENDER_LINEDISTANCE,i=r/10,o=(s-1)*r/2,h=new l(4*s+10);for(let t=0;t<s;t++){let e=r*t-o;h.setVector(2*t,new n(e,-o,0)),h.setVector(2*t+1,new n(e,o,0))}for(let t=0;t<s;t++)h.setVector(2*s+2*t,new n(-o,r*t-o,0)),h.setVector(2*s+2*t+1,new n(o,r*t-o,0));let a=h.count()-10;h.setVector(a,new n(o+i,-i,0)),h.setVector(a+1,new n(o+4*i,i,0));let u=h.count()-8;h.setVector(u,new n(o+i,i,0)),h.setVector(u+1,new n(o+4*i,-i,0));let d=h.count()-6;h.setVector(d,new n(0,o+2.5*i,0)),h.setVector(d+1,new n(i,o+4*i,0));let c=h.count()-4;h.setVector(c,new n(i,o+i,0)),h.setVector(c+1,new n(-i,o+4*i,0));let g=h.count()-2;return h.setVector(g,new n(0,0,0)),h.setVector(g+1,new n(0,0,r)),h.forEach((e=>t.pushToWorld(e))),new _(h)}static fromCircle(t){let s=e.CIRCLE_SEGMENTS,r=new l(s);for(let e=0;e<s;e++){let i=e/s*(2*Math.PI);r.setVector(e,t.plane.pushToWorld(new n(Math.cos(i)*t.radius,Math.sin(i)*t.radius,0)))}return new _(r,function(t){let e=new Uint16Array(2*t);for(let s=0;s<t;s++)e[2*s]=s,e[2*s+1]=(s+1)%t;return e}(s))}static fromSpline(){throw"todo!"}static fromCube(t){let e=l.fromList(t.getCorners());return new _(e)}static fromJoin(t){let e=0,s=0;for(let r of t)e+=r.links.length,s+=r.verts.count();let r=new l(s),i=new Uint16Array(e),n=0,o=0;for(let e of t){for(let t=0;t<e.verts.count();t++)r.setRow(n+t,e.verts.getRow(t));for(let t=0;t<e.links.length;t++)i[o+t]=e.links[t]+n;n+=e.verts.count(),o+=e.links.length}return new _(r,i)}}class b{constructor(t,e){this.origin=t,this.normal=e.normalize()}static fromNormal(t,e){return new b(t,e)}static fromPoints(t,e){return new b(t,e.subbed(t).normalize())}at(t){return this.origin.added(this.normal.scaled(t))}xPlane(t){return-(this.origin.dot(t.normal)+t.d)/this.normal.dot(t.normal)}toLine(t){let e=this.at(t);return _.fromLines([this.origin,e])}}class V{constructor(t,e=1,s=!1,r=!0){this.angleAlpha=0,this.angleBeta=0,this.mousePos=h.zero(),this.fov=20*Math.PI/100,this.zFar=1e4,this.zNear=.1,this.speed=1,this.worldPlane=f.WorldXY(),this.canMove=s,this.canControl=r,this.pos=new n(0,0,0),this.z_offset=-e,this.offset=new n(0,0,-e),this.updateMatrices(t)}new(t,e=1,s=!1){return new V(t,e,s)}update(t){this.updateControls(t),this.updateMatrices(t.canvas),this.updateClick(t),t.IsKeyPressed("p")&&(console.log("camera state: ",this.pos.x,this.pos.y,this.pos.z,this.z_offset,this.angleAlpha,this.angleBeta),console.log("speed is now: "+this.speed))}getState(){return[this.pos.x,this.pos.y,this.pos.z,this.z_offset,this.angleAlpha,this.angleBeta]}setState(t){this.pos.x=t[0],this.pos.y=t[1],this.pos.z=t[2],this.z_offset=t[3],this.angleAlpha=t[4],this.angleBeta=t[5]}set(t,e,s){this.z_offset=t,this.angleAlpha=e,this.angleBeta=s}updateMatrices(t){this.worldMatrix=this.getWorldMatrix(),this.projectMatrix=this.getProjectionMatrix(t),this.totalMatrix=this.worldMatrix.multiplied(this.projectMatrix)}lookat(t,e){i.newLookAt(t,e,this.worldPlane.khat)}updateClick(t){}updateControls(t){if(!this.canControl)return;let e=1.2*t.scrollValue;this.offset.z=Math.min(-.001,this.z_offset-e),t.IsKeyPressed("Shift")&&(this.speed*=2),t.IsKeyPressed("Control")&&(this.speed=Math.max(.5*this.speed,.1));let r=this.mousePos.clone();this.mousePos=t.mousePos.clone();let o=r.clone().sub(this.mousePos);function h(t){return i.newZRotation(t).multiplyVector(n.unitY())}function a(t){return i.newZRotation(t).multiplyVector(n.unitX())}this.getMouseWorldRay(t.canvas.width,t.canvas.height),t.mouseRightDown&&(this.angleAlpha=s.clamp(this.angleAlpha+.01*o.y,0,Math.PI),this.angleBeta+=-.01*o.x),this.canMove&&(t.IsKeyDown("s")&&this.pos.add(h(-this.angleBeta).scale(.01*this.speed)),t.IsKeyDown("w")&&this.pos.add(h(-this.angleBeta).scale(-.01*this.speed)),t.IsKeyDown("a")&&this.pos.add(a(-this.angleBeta).scale(.01*this.speed)),t.IsKeyDown("d")&&this.pos.add(a(-this.angleBeta).scale(-.01*this.speed)),t.IsKeyDown("q")&&(this.pos.z+=.01*this.speed),t.IsKeyDown("e")&&(this.pos.z-=.01*this.speed))}getCameraPoint(){return this.worldMatrix.inverse().multiplyVector(new n(0,0,0))}getMouseWorldRay(t,e,s=!0){let r=this.mousePos,i=t/e,o=(r.x/t-.5)*i,h=r.y/e-.5,a=.5/Math.tan(this.fov/2),l=this.worldMatrix.inverse(),u=l.multiplyVector(new n(0,0,0)),d=l.multiplyVector(new n(1,0,0)),c=l.multiplyVector(new n(0,1,0)),g=l.multiplyVector(new n(0,0,-1)),m=d.sub(u).normalize(),f=c.sub(u).normalize(),w=g.sub(u).normalize(),p=s?u.added(w.scaled(a)).add(m.scaled(o)).add(f.scaled(-h)):u.added(w.scaled(a));return b.fromPoints(u,p)}getWorldMatrix(){let t=this.offset,e=this.angleAlpha,s=this.angleBeta,r=(new i([1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1]),i.newTranslation(this.pos.x,this.pos.y,this.pos.z)),n=i.newTranslation(t.x,t.y,t.z),o=i.newXRotation(e),h=i.newZRotation(s).multiply(o);return r.multiply(h).multiply(n)}getProjectionMatrix(t){let e=t.width/t.height;return i.newPerspective(this.fov,e,this.zNear,this.zFar)}}class A{constructor(t){this.camera=t}}var R,L,P,z,T=0;(L=R||(R={}))[L.StaticDraw=0]="StaticDraw",L[L.DynamicDraw=1]="DynamicDraw";class S{constructor(t,e,s){this.gl=t,this.program=S.createProgramFromScripts(t,e,s)}setAndRender(t,e){this.set(t,R.DynamicDraw),this.render(e)}static getNextTextureID(){let t=T;return T+=1,t}static resizeCanvas(t){let e=t.canvas;const s=e.clientWidth,r=e.clientHeight,i=t.canvas.width!==s||t.canvas.height!==r;return i&&(t.canvas.width=s,t.canvas.height=r),t.viewport(0,0,t.canvas.width,t.canvas.height),i}convertDrawSpeed(t){return t==R.DynamicDraw?this.gl.DYNAMIC_DRAW:this.gl.STATIC_DRAW}static initWebglContext(t){let e=t.getContext("webgl");null==e&&console.log("webgl unavailable...");let s=e;return s.enable(s.BLEND),s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA),s.enable(s.CULL_FACE),s.enable(s.DEPTH_TEST),s.clearColor(0,0,0,1),s.clearDepth(1),s}static compileShader(t,e,s){let r=t.createShader(s);if(t.shaderSource(r,e),t.compileShader(r),!t.getShaderParameter(r,t.COMPILE_STATUS))throw"could not compile shader:"+e+t.getShaderInfoLog(r);return r}static createProgram(t,e,s){let r=t.createProgram();if(t.attachShader(r,e),t.attachShader(r,s),t.linkProgram(r),!t.getProgramParameter(r,t.LINK_STATUS))throw"program failed to link:"+t.getProgramInfoLog(r);return r}static createProgramFromScripts(t,e,s){let r=S.compileShader(t,e,t.VERTEX_SHADER),i=S.compileShader(t,s,t.FRAGMENT_SHADER);return S.createProgram(t,r,i)}}!function(t){t[t.A=0]="A",t[t.B=1]="B",t[t.C=2]="C",t[t.D=3]="D",t[t.E=4]="E",t[t.F=5]="F",t[t.G=6]="G",t[t.H=7]="H",t[t.I=8]="I",t[t.J=9]="J",t[t.K=10]="K",t[t.L=11]="L",t[t.M=12]="M",t[t.N=13]="N",t[t.O=14]="O",t[t.P=15]="P",t[t.Q=16]="Q",t[t.R=17]="R",t[t.S=18]="S",t[t.T=19]="T",t[t.U=20]="U",t[t.V=21]="V",t[t.W=22]="W",t[t.X=23]="X",t[t.Y=24]="Y",t[t.Z=25]="Z",t[t.Up=26]="Up",t[t.Down=27]="Down",t[t.Left=28]="Left",t[t.Right=29]="Right",t[t.Space=30]="Space",t[t.Control=31]="Control",t[t.Alt=32]="Alt",t[t.Shift=33]="Shift",t[t.Enter=34]="Enter",t[t.Esc=35]="Esc",t[t.N1=36]="N1",t[t.N2=37]="N2",t[t.N3=38]="N3",t[t.N4=39]="N4",t[t.N5=40]="N5",t[t.N6=41]="N6",t[t.N7=42]="N7",t[t.N8=43]="N8",t[t.N9=44]="N9",t[t.N0=45]="N0",t[t.Plus=46]="Plus",t[t.Minus=47]="Minus",t[t.Backspace=48]="Backspace"}(P||(P={}));class N{constructor(t){this.mousePos=h.zero(),this.mouseDelta=h.zero(),this.mouseLeftDown=!1,this.mouseLeftPressed=!1,this.mouseLeftPrev=!1,this.mouseRightDown=!1,this.mouseRightPressed=!1,this.mouseRightPrev=!1,this.mouseMiddleDown=!1,this.mouseMiddlePressed=!1,this.mouseMiddlePrev=!1,this.keysDown={},this.keysPressed=[],this.scrollValue=0,this.canvas=t,this.tick=0,this.oldTime=Date.now(),this.newTime=this.oldTime,this.startTime=Date.now(),this.minimumTick=1e3/144,t.addEventListener("mousedown",this.setMouseDown.bind(this)),t.addEventListener("mouseup",this.setMouseUp.bind(this)),t.addEventListener("contextmenu",(t=>{t.preventDefault(),t.stopPropagation()})),document.addEventListener("mousemove",this.setMousePos.bind(this)),t.addEventListener("wheel",this.setMouseScroll.bind(this)),document.addEventListener("touchmove",this.setTouch.bind(this)),t.addEventListener("touchstart",this.setTouch.bind(this)),t.addEventListener("touchend",this.setTouchUp.bind(this));for(let t=0;t<223;t++)this.keysDown[t]=!1;t.addEventListener("keydown",this.onKeyDown.bind(this)),t.addEventListener("keyup",this.onKeyUp.bind(this)),t.focus()}preUpdate(){this.newTime=Date.now(),this.tick=this.newTime-this.oldTime,this.oldTime=this.newTime,this.mouseLeftPressed=this.mouseLeftPrev!=this.mouseLeftDown&&this.mouseLeftDown,this.mouseRightPressed=this.mouseRightPrev!=this.mouseRightDown&&this.mouseRightDown,this.mouseMiddlePressed=this.mouseMiddlePrev!=this.mouseMiddleDown&&this.mouseMiddleDown,this.mouseLeftPrev=this.mouseLeftDown,this.mouseRightPrev=this.mouseRightDown,this.mouseMiddlePrev=this.mouseMiddleDown}postUpdate(){this.keysPressed=[]}IsKeyDown(t){return this.keysDown[t]}IsKeyPressed(t){return this.keysPressed.includes(t)}onKeyDown(t){1!=this.keysDown[t.key]&&(console.log(t.key),this.keysDown[t.key.toLowerCase()]=!0,this.keysPressed.push(t.key))}onKeyUp(t){this.keysDown[t.key.toLowerCase()]=!1}onKeyPressed(t){}setTouch(t){t.preventDefault(),this.mousePos=new h(t.touches[0].clientX,t.touches[0].clientY),this.mouseLeftDown=!0}setTouchUp(t){t.preventDefault(),this.mouseLeftDown=!1}setMouseScroll(t){let e=.1;t.deltaY<0&&(e=-.1),this.scrollValue=Math.max(0,this.scrollValue+e)}setMousePos(t){this.mousePos=new h(t.clientX,t.clientY)}setMouseUp(t){let e=t.buttons;e<4&&(this.mouseMiddleDown=!1),e<2&&(this.mouseRightDown=!1),e<1&&(this.mouseLeftDown=!1)}setMouseDown(t){t.preventDefault(),t.stopPropagation(),this.canvas.focus();let e=t.buttons;return e>=4&&(e-=4,this.mouseMiddleDown=!0),e>=2&&(e-=2,this.mouseRightDown=!0),e>=1&&(e-=1,this.mouseLeftDown=!0),!1}}class C{constructor(t){this.globalContext=t,this.currentContext=t}toggleVisibility(){this.globalContext.hidden?this.show():this.hide()}hide(){this.globalContext.hidden=!0}show(){this.globalContext.hidden=!1}addContext(t){this.currentContext=this.globalContext;let e=this.addDiv(t+" app-interface");this.currentContext=e}setContext(t){this.globalContext.getElementsByClassName(t)}removeContext(t){this.setContext(t);for(let t=this.currentContext.childElementCount-1;t>=0;t-=1)this.currentContext.removeChild(this.currentContext.children.item(t));let e=this.currentContext;this.currentContext=this.globalContext,this.currentContext.removeChild(e)}addElement(t,e=""){let s=document.createElement(t);return s.className=e,this.currentContext.appendChild(s),s}addDiv(t,e=[]){let s=this.addElement("div",t);return e.forEach((t=>{s.appendChild(t)})),s}addBooleanParameter(t,e=(()=>{})){let s=this.addElement("input","checkbox");s.type="checkbox",s.addEventListener("change",(()=>{let r=s.checked;t.set(r?1:0),e(s.valueAsNumber),n.innerText=t.name})),s.checked=1==t.get();let r=this.addElement("label","check-container"),i=this.addElement("span","checkmark");r.appendChild(s),r.appendChild(i);let n=this.addElement("p","control-text");return n.innerText=t.name,this.addDiv("control",[n,r]),s}addParameter(t,e=(()=>{})){let s;s=t instanceof k?t.p:t;let r=this.addRangeInput(s,e),i=this.addElement("p","control-text");i.innerText=s.name;let n=this.addElement("p","control-value");return n.innerText=t instanceof k?t.getName():r.value,this.addDiv("control",[i,r,n]),t.setSliderAndText(r,n),r.oninput=()=>{s.set(r.valueAsNumber,!1),e(r.valueAsNumber),n.innerText=t instanceof k?t.getName():r.value},r}addRangeInput(t,e=(()=>{})){let s=this.addElement("input","control-slider");return s.type="range",s.min=t.min.toString(),s.max=t.max.toString(),s.valueAsNumber=t.state,s.step=t.step.toString(),s}addText(t){this.addElement("p","ui-text").innerText=t}addButton(t,e){let s=this.addElement("button","control-button");s.innerText=t,s.addEventListener("click",e);let r=this.addElement("p","control-text");return this.addDiv("control",[r,s])}addDropdown(t,e){let s=t.values.length,r=this.addElement("select","enum-selector dropdown-select");for(let e=0;e<s;e++){let s=this.addElement("option","enum-item");s.innerText=t.values[e],r.appendChild(s)}return r.addEventListener("change",(s=>{let r=s.target.selectedIndex;t.set(r),e(r)})),this.addDiv("dropdown-dark",[r]),r}}class D{constructor(t,e,s=-1/0,r=1/0,i=.1){this.name=t,this.min=s,this.max=r,this.step=i,this.state=e,this.set(this.state)}static new(t,e,s=-1/0,r=1/0,i=.1){return new D(t,e,s,r,i)}static newBoolean(t,e){return new D(t,e?1:0,0,1,1)}get(){return this.state}set(t,e=!0){s.clamp(t,this.min,this.max);let r=t-this.min,i=Math.round(r/this.step),n=this.min+this.step*i;this.state=s.clamp(n,this.min,this.max),e&&this.slider&&this.text&&this.onset()}getNPermutations(){return Math.min((this.max-this.min)/this.step+1)}setSliderAndText(t,e){this.slider=t,this.text=e}onset(){this.slider.valueAsNumber=this.state,this.text.innerText=this.state.toString()}}class k{constructor(t,e){this.p=t,this.values=e}static new(t,e,s){return new k(new D(t,e,0,s.length-1,1),s)}getName(){return this.values[this.get()]}get(){return this.p.get()}set(t){return this.p.set(t)}getNPermutations(){return this.p.getNPermutations()}setSliderAndText(t,e){this.slider=t,this.text=e}onset(){this.slider.valueAsNumber=this.get(),this.text.innerText=this.getName()}}class I{constructor(){this.fps=0,this.updateEveryXTicks=100,this.elapsed=0,this.frames=0}update(t){this.frames+=1,this.elapsed+=t.tick,this.elapsed>this.updateEveryXTicks&&(this.setFps(),this.elapsed=0,this.frames=0)}setFps(){this.fps=Math.round(this.frames/this.elapsed*1e3)}getFps(){return this.fps}}class F{constructor(t,e,s){this.STOP=!1,this.canvas=t,this.gl=e,this.state=new N(t),this.fpsCounter=new I,this.ui=new C(s),this.apps=new Map}addApp(t){this.apps.set(t.name,t),this.activateApp(t)}removeApp(t){this.ui.removeContext(t),this.apps.delete(t)}activateApp(t){this.ui.addContext(t.name),this.ui.addText(t.description),t.ui(this.ui),t.start()}update(){this.state.preUpdate(),this.fpsCounter.update(this.state),this.state.IsKeyPressed("Esc")&&(this.STOP=!0),this.apps.forEach((t=>{t.update(this.state)})),this.state.postUpdate()}draw(){const t=this.canvas,e=this.gl;window.innerHeight==t.height&&window.innerWidth==t.width||(t.height=window.innerHeight,t.style.height=window.innerHeight.toString(),t.width=window.innerWidth,t.style.width=window.innerWidth.toString(),e.viewport(0,0,window.innerWidth,window.innerHeight)),this.gl.clearColor(0,0,0,0),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.apps.forEach((t=>{t.draw(this.gl)}))}}function B(t,e,s,r,i){let n=1+s/e,o=1+r/e,h=[],a=t.allVertLoopsAsInts();for(let e of a){if(Math.random()>i)continue;if(e.length<4)continue;let s=e.map((e=>t.getVertexPos(e))),r=y.newOct([s[0].scaled(n),s[1].scaled(n),s[3].scaled(n),s[2].scaled(n),s[0].scaled(o),s[1].scaled(o),s[3].scaled(o),s[2].scaled(o)]);h.push(r)}return y.fromJoin(h)}class U extends S{constructor(t,e=[1,0,0,.5]){super(t,"\n        precision mediump int;\n        precision mediump float;\n\n        attribute vec4 a_position;\n        uniform mat4 u_transform;\n        uniform mat4 u_personal;\n        uniform vec4 u_color;\n\n        void main() {\n            gl_Position = u_transform * u_personal * a_position;\n        }\n        ","\n        precision mediump int;\n        precision mediump float;\n\n        uniform vec4 u_color;\n\n        void main () {\n            gl_FragColor = u_color;\n        }\n        "),this.u_transform=t.getUniformLocation(this.program,"u_transform"),this.u_personal=t.getUniformLocation(this.program,"u_personal"),this.u_color=t.getUniformLocation(this.program,"u_color"),this.a_position=t.getAttribLocation(this.program,"a_position"),this.a_position_buffer=t.createBuffer(),this.index_buffer=t.createBuffer(),t.useProgram(this.program),this.count=0,this.vertCount=0,this.personal=i.newIdentity(),this.color=e}static new(t,e=[1,0,0,.5]){return new U(t,e)}set(t,e=R.StaticDraw){let s,r,i=this.gl;r=t.mesh.verts,s=t.mesh.toLines().links.getData(),this.personal=t.position,this.color=t.linecolor,i.useProgram(this.program),this.count=s.length,this.vertCount=r._width;let n=this.convertDrawSpeed(e);i.bindBuffer(i.ARRAY_BUFFER,this.a_position_buffer),i.enableVertexAttribArray(this.a_position),i.vertexAttribPointer(this.a_position,this.vertCount,i.FLOAT,!1,0,0),i.bufferData(i.ARRAY_BUFFER,r.data,n),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,this.index_buffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,s.buffer,n)}render(t){let e=this.gl,s=t.camera.totalMatrix;e.useProgram(this.program),e.bindBuffer(e.ARRAY_BUFFER,this.a_position_buffer),e.enableVertexAttribArray(this.a_position),e.vertexAttribPointer(this.a_position,this.vertCount,e.FLOAT,!1,0,0),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.index_buffer),e.uniform4f(this.u_color,this.color[0],this.color[1],this.color[2],this.color[3]),e.uniformMatrix4fv(this.u_transform,!1,s.data),e.uniformMatrix4fv(this.u_personal,!1,this.personal.data),e.drawElements(e.LINES,this.count,e.UNSIGNED_SHORT,0)}}class O extends S{constructor(t,e=[1,0,0,.25]){super(t,"\n        precision mediump int;\n        precision mediump float;\n\n        attribute vec4 a_position;\n        uniform mat4 u_transform;\n        uniform mat4 u_personal;\n        uniform vec4 u_color;\n\n        void main() {\n            gl_Position = u_transform * u_personal * a_position;\n        }\n        ","\n        precision mediump int;\n        precision mediump float;\n\n        uniform vec4 u_color;\n\n        void main () {\n            gl_FragColor = u_color;\n        }\n        "),this.u_transform=t.getUniformLocation(this.program,"u_transform"),this.u_personal=t.getUniformLocation(this.program,"u_personal"),this.u_color=t.getUniformLocation(this.program,"u_color"),t.useProgram(this.program),this.count=0,this.size=0,this.a_position=t.getAttribLocation(this.program,"a_position"),this.a_position_buffer=t.createBuffer(),this.index_buffer=t.createBuffer(),this.personal=i.newIdentity(),this.color=e}set(t,e=R.StaticDraw){let s=this.gl,r=t.mesh;this.color=t.color,this.personal=t.position,s.useProgram(this.program),this.count=r.links.data.length,s.bindBuffer(s.ARRAY_BUFFER,this.a_position_buffer),this.size=3,s.FLOAT,s.vertexAttribPointer(this.a_position,this.size,s.FLOAT,!1,0,0),s.bufferData(s.ARRAY_BUFFER,r.verts.data,this.convertDrawSpeed(e)),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,this.index_buffer),s.bufferData(s.ELEMENT_ARRAY_BUFFER,r.links.data,this.convertDrawSpeed(e))}render(t){let e=this.gl,s=t.camera.totalMatrix;e.useProgram(this.program),e.enableVertexAttribArray(this.a_position),e.bindBuffer(e.ARRAY_BUFFER,this.a_position_buffer),e.vertexAttribPointer(this.a_position,this.size,e.FLOAT,!1,0,0),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.index_buffer),e.uniformMatrix4fv(this.u_transform,!1,s.data),e.uniformMatrix4fv(this.u_personal,!1,this.personal.data),e.uniform4f(this.u_color,this.color[0],this.color[1],this.color[2],this.color[3]),e.drawElements(e.TRIANGLES,this.count,e.UNSIGNED_SHORT,0)}setAndRender(t,e){this.set(t,R.DynamicDraw),this.render(e)}}class q extends class{constructor(t,e,s){this.state=e,this.buffered,this.renderer=s(t)}buffer(){}render(t){this.renderer.render(t)}}{constructor(t){super(t,y.newEmpty(0,0,0),U.new),this.color=[0,0,0,.8],this.linecolor=[.3,.3,.3,1],this.renderer2=new O(t)}static new(t){return new q(t)}set(t){this.state=t,this.buffer()}buffer(){this.buffered=this.state.toRenderable(),this.buffered.calculateFaceNormals(),this.buffered.color=this.color,this.buffered.linecolor=this.linecolor,this.commit()}commit(){this.buffered.color=this.color,this.buffered.linecolor=this.linecolor,this.renderer.set(this.buffered,R.StaticDraw),this.renderer2.set(this.buffered,R.StaticDraw)}render(t){this.renderer2.render(t),this.renderer.render(t)}}class W extends class{constructor(t,e=""){this.gl=t,this.name=this.constructor.name,this.description=e}ui(t){}start(){}update(t){}draw(t){}}{constructor(t){super(t,"Multiple Layers of spherical geometry"),this.radius=.1,this.smoothlimit=0,this.worlds=[],this.lerpColorState=0,this.mousePos=new h(0,0),this.lerpSpeed=.1,this.color=[0,0,0,.30],this.linecolor=[0.6,0.6,0.6,0.3],this.camStates=new Map([["side",[-.413470964,1.49448,.83,-1,2.379899,.751]],["low-side",[-.41302839,1.49265395,.83134874,-1,1.37494473,-1.830813444]],["bottom",[-.3182952,1.1018537,1.11999998,-1,1.31959045,-.3189964]],["overview",[0,0,-2.5999999999999885,-1,0,0]],["top",[-1.32173,-.64986,.14,-1,2.4,-2.04]],["inside",[0,0,0,-1,0,0]]]),this.goto="",this.lerpPosState=0;let e=t.canvas;this.c=new A(new V(e,1,!1,!1))}ui(t){let e=()=>{this.start()};this.rotate=new D("rotate",1,0,1,1),this.randomEdges=new D("delete edges",1,0,1,1),this.smooth=new D("smooth",0,0,1,1),this.subCount=new D("sub count",2,0,4,1),this.quadSubCount=new D("sub count quad",1,0,2,1),this.liftType=k.new("lift type",1,["none","sphere","buggy"]),t.hide(),t.addBooleanParameter(this.rotate),t.addBooleanParameter(this.randomEdges,e),t.addBooleanParameter(this.smooth),t.addParameter(this.subCount,e),t.addParameter(this.quadSubCount,e),t.addParameter(this.liftType,e),t.addButton("recalculate",e); let sss=this.gl.canvas.getAttribute("data-sub-count");console.log(sss);this.subCount.set(sss);}start(){this.radius=1,this.smoothlimit=0,this.graph=function(t,e,s,r){let i=y.newIcosahedron(.5).toGraph(),o=new n(0,0,0);for(let s=0;s<e;s++)if(i.subdivide(),t>0){let e=i.getVertexCount();for(let s=0;s<e;s++){let e=i.getVertexPos(s),r=e,n=1-o.disTo(e);t>1?e.add(r.scaled(n)):e.add(r.normalized().scaled(n))}}1==r&&function(t){let e=t.edges.length,s=new Array(e),r=new Array(e);t.edges.forEach(((t,e)=>{s[e]=e,r[e]=!1})),s.sort(((t,e)=>.5-Math.random()));for(let i=0;i<e;i++){let e=s[i];if(t.edges[e].dead||r[e])continue;let n=t.getLoopsAdjacentToEdge(e);if(!(n[0].length>3||n[1].length>3)){for(let t of n)for(let e of t)r[e]=!0;t.deleteEdgeByIndex(e)}}}(i);for(let t=0;t<s;t++)i.subdivideQuad();if(t>0){let e=i.getVertexCount();for(let s=0;s<e;s++){let e=i.getVertexPos(s),r=i.getVertexNormal(s),n=1-o.disTo(e);t>1?e.add(r.scaled(n)):e.add(r.normalized().scaled(n))}}return i}(1,this.subCount.get(),this.quadSubCount.get(),this.randomEdges.get()),this.average=function(t){let e=0,s=0;return t.forEveryEdgeVerts(((t,r)=>{s+=t.disTo(r),e+=1})),s/e}(this.graph),this.bufferWorld()}bufferWorld(){this.worlds=[];let t=[0,.1,.2,.3],e=[.7,.5,.3];for(let s=0;s<3;s++){let r=t[s],i=t[s+1],n=e[s],o=q.new(this.gl);o.set(B(this.graph,this.radius,r,i,n)),this.worlds.push(o)}}update(t){this.c.camera.update(t);let e=7e-5*t.tick,r=1+3*Math.log10(1+this.mousePos.disTo(t.mousePos));if(this.mousePos=t.mousePos,e*=r,this.lerpSpeed=s.lerp(this.lerpSpeed,e,.02),1==this.rotate.get()){let t=this.lerpSpeed,e=i.newXRotation(t),s=i.newYRotation(t),r=e.multiply(s);this.worlds[0].buffered.position.multiply(r),this.worlds[1].buffered.position.multiply(i.newXRotation(-t)),this.worlds[2].buffered.position.multiply(i.newZRotation(-t))}this.updateColors(t),this.updateCamPos(t);for(let t of this.worlds)t.commit()}updateCamPos(t){let s=this.gl.canvas.getAttribute("data-goto");if(!s||s==this.goto)return;let r=this.camStates.get(s);if(!r)return;let i=!1,n=this.c.camera.getState();if(r.map(((t,s)=>{let r=t-n[s];return Math.abs(r)>50*e.TOLERANCE&&(i=!0),r})),!i)return this.goto=s,void console.log("arrival!");this.goto="";const o=.0012*t.tick;let h=K(n,r,o);this.c.camera.setState(h)}updateColors(t){let e=this.gl.canvas;const r=5e-4*t.tick;let i=e.getAttribute("data-filled");if("1"==i&&this.lerpColorState<1)this.lerpColorState+=r;else{if(!("0"==i&&this.lerpColorState>0))return;this.lerpColorState-=r}let n=s.fade(this.lerpColorState),o=s.fade(Math.min(2*this.lerpColorState,1));this.worlds.forEach((t=>{t.color=K(this.color,[0,0,0,0],1-n),t.linecolor=K(this.linecolor,[0,0,0,0],1-o)})),this.lerpSpeed*=n;}draw(t){if(0!=this.lerpColorState)for(let t of this.worlds)t.render(this.c)}}function K(t,e,s){return t.map(((t,r)=>t*(1-s)+e[r]*s))}window.addEventListener("load",(function(){!function(){let t=document.getElementById("canvas"),e=(document.getElementById("camera"),document.getElementById("interface")),s=(document.getElementById("camera-on"),document.getElementById("camera-off"),document.getElementById("predict"),S.initWebglContext(t));z=new F(t,s,e);let r=new W(s);z.addApp(r),requestAnimationFrame((function t(){z.STOP||(z.update(),z.draw(),requestAnimationFrame(t))}))}()}),!1)})();